{"version":3,"file":"o-table-export-dialog.component.js","sourceRoot":"","sources":["../../../../../../../tmp/ontimize/components/table/extensions/dialog/export/o-table-export-dialog.component.ts"],"names":[],"mappings":"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","sourcesContent":["import { HttpErrorResponse } from '@angular/common/http';\nimport { ChangeDetectionStrategy, Component, Inject, Injector, OnDestroy, OnInit, ViewEncapsulation } from '@angular/core';\nimport { MAT_DIALOG_DATA, MatButton, MatDialogRef } from '@angular/material';\nimport { Subscription } from 'rxjs';\nimport { filter } from 'rxjs/operators';\n\nimport { DialogService, OntimizeExportService, OTranslateService } from '../../../../../services';\nimport { exportServiceFactory } from '../../../../../services/factories';\nimport { IExportService } from '../../../../../types/export-service.interface';\nimport { Codes, SQLTypes, Util } from '../../../../../utils';\nimport { OTableExportButtonService } from '../../export-button/o-table-export-button.service';\n\nexport class OTableExportConfiguration {\n  columns: Array<any>;\n  columnNames: Object;\n  sqlTypes: Object;\n  service: string;\n  serviceType: string;\n  data?: any[];\n  filter?: Object;\n  mode: string;\n  entity: string;\n  visibleButtons: string;\n  options?: any;\n}\n\n@Component({\n  moduleId: module.id,\n  selector: 'o-table-export-dialog',\n  template: `\n    <span mat-dialog-title>{{ 'TABLE.BUTTONS.EXPORT' | oTranslate }}</span>\n    <mat-dialog-content>\n      <div mat-subheader>{{ 'TABLE.DIALOG.EXPORT.DESCRIPTION' | oTranslate }}</div>\n      <div fxLayout=\"row wrap\" fxLayoutAlign=\"space-around center\" fxLayoutGap=\"8px\">\n        <o-table-export-button #excelButton *ngIf=\"isButtonVisible('excel')\" svg-icon=\"ontimize:EXCEL\" label=\"TABLE.BUTTONS.EXCEL\" export-type=\"xlsx\"\n          (onClick)=\"export('xlsx', excelButton)\" class=\"excel-button\"></o-table-export-button>\n        <o-table-export-button #htmlButton *ngIf=\"isButtonVisible('html')\" svg-icon=\"ontimize:HTML\" label=\"TABLE.BUTTONS.HTML\" export-type=\"html\"\n          (onClick)=\"export('html', htmlButton)\" class=\"html-button\"></o-table-export-button>\n        <o-table-export-button #pdfButton *ngIf=\"isButtonVisible('pdf')\" svg-icon=\"ontimize:PDF\" label=\"TABLE.BUTTONS.PDF\" export-type=\"pdf\"\n          (onClick)=\"export('pdf', pdfButton)\" class=\"pdf-button\"></o-table-export-button>\n        <ng-container *ngTemplateOutlet=\"config.options\"></ng-container>\n      </div>\n    </mat-dialog-content>\n\n    <mat-dialog-actions fxLayoutAlign=\"end center\">\n      <button type=\"button\" mat-stroked-button [mat-dialog-close]=\"false\">{{ 'CANCEL' | oTranslate | uppercase }}</button>\n    </mat-dialog-actions>\n  `,\n  styles: [`\n    .o-table-export-dialog .mat-icon{padding:6px 6px 0;width:48px;height:48px;font-size:48px}\n  `],\n  providers: [\n    { provide: OntimizeExportService, useFactory: exportServiceFactory, deps: [Injector] }\n  ],\n  changeDetection: ChangeDetectionStrategy.OnPush,\n  host: {\n    'class': 'o-table-export-dialog'\n  },\n  encapsulation: ViewEncapsulation.None\n})\nexport class OTableExportDialogComponent implements OnInit, OnDestroy {\n\n  protected dialogService: DialogService;\n  protected exportService: IExportService;\n  protected translateService: OTranslateService;\n  protected oTableExportButtonService: OTableExportButtonService;\n  protected visibleButtons: string[];\n  private subscription: Subscription = new Subscription();\n\n  constructor(\n    public dialogRef: MatDialogRef<OTableExportDialogComponent>,\n    protected injector: Injector,\n    @Inject(MAT_DIALOG_DATA) public config: OTableExportConfiguration\n  ) {\n    this.dialogService = injector.get(DialogService);\n    this.translateService = this.injector.get(OTranslateService);\n    this.oTableExportButtonService = this.injector.get(OTableExportButtonService);\n\n    if (config && Util.isDefined(config.visibleButtons)) {\n      this.visibleButtons = Util.parseArray(config.visibleButtons.toLowerCase(), true);\n    }\n  }\n\n  ngOnInit() {\n    this.initialize();\n  }\n\n  ngOnDestroy() {\n    this.subscription.unsubscribe();\n  }\n\n  initialize(): void {\n    this.configureService();\n    this.subscription.add(\n      this.oTableExportButtonService.export$.pipe(filter(type => ['xlsx', 'html', 'pdf'].indexOf(type) === -1)).subscribe(e => this.export(e))\n    );\n  }\n\n  configureService(): void {\n    let loadingService: any = OntimizeExportService;\n    if (this.config.serviceType) {\n      loadingService = this.config.serviceType;\n    }\n    this.exportService = this.injector.get(loadingService);\n    let serviceCfg = this.exportService.getDefaultServiceConfiguration(this.config.service);\n    this.exportService.configureService(serviceCfg, Codes.EXPORT_MODE_ALL === this.config.mode);\n  }\n\n  export(exportType: string, button?: MatButton): void {\n    if (button) {\n      button.disabled = true;\n    }\n    let exportData = {\n      data: this.config.data,\n      columns: this.config.columns,\n      columnNames: this.config.columnNames,\n      sqlTypes: this.config.sqlTypes,\n      filter: this.config.filter\n    };\n    let self = this;\n    this.proccessExportData(exportData.data, exportData.sqlTypes);\n    this.exportService.exportData(exportData, exportType, this.config.entity)\n      .subscribe(\n        res => self.dialogRef.close(true),\n        err => self.handleError(err)\n      );\n  }\n\n  proccessExportData(data: Object[], sqlTypes: Object): void {\n    // Parse boolean\n    Object.keys(sqlTypes).forEach(key => {\n      if (SQLTypes.BOOLEAN === sqlTypes[key]) {\n        let yes = this.translateService.get('YES');\n        let no = this.translateService.get('NO');\n        data.forEach(row => {\n          if (row[key]) {\n            row[key] = Util.parseBoolean(row[key]) ? yes : no;\n          }\n        });\n      }\n    });\n  }\n\n  isButtonVisible(btn: string): boolean {\n    return !this.visibleButtons || (this.visibleButtons.indexOf(btn) !== -1);\n  }\n\n  protected handleError(err): void {\n    console.error(err);\n    const self = this;\n    if (err instanceof HttpErrorResponse) {\n      this.dialogService.alert('ERROR', err.message).then(() => self.dialogRef.close(false));\n    } else {\n      this.dialogService.alert('ERROR', 'MESSAGES.ERROR_EXPORT_TABLE_DATA').then(() => self.dialogRef.close(false));\n    }\n  }\n\n}\n"]}